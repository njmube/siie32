/*
 * DFormCompany.java
 *
 * Created on 19 de agosto de 2008, 11:10 AM
 */

package erp.mmfg.form;

import java.awt.event.ActionEvent;
import java.awt.event.KeyEvent;
import java.util.Vector;
import javax.swing.AbstractAction;
import javax.swing.JOptionPane;

import erp.data.SDataConstants;
import erp.data.SDataConstantsSys;
import erp.data.SDataUtilities;
import erp.lib.SLibUtilities;
import erp.lib.form.SFormField;
import erp.lib.form.SFormValidation;
import erp.lib.form.SFormUtilities;
import erp.lib.SLibConstants;
import erp.lib.SLibTimeUtilities;
import erp.mitm.data.SDataItem;
import erp.mmfg.data.SDataProductionOrder;
import erp.mtrn.data.SDataStockLot;
import erp.mtrn.data.STrnUtilities;

/**
 *
 * @author  Néstor Ávalos
 */
public class SDialogMfgAssignRework extends javax.swing.JDialog implements erp.lib.form.SFormInterface, java.awt.event.ActionListener {

    private int mnFormType;
    private int mnFormResult;
    private int mnFormStatus;
    private boolean mbFirstTime;
    private boolean mbResetingForm;
    private java.util.Vector<erp.lib.form.SFormField> mvFields;
    private erp.client.SClientInterface miClient;

    private erp.mmfg.data.SDataProductionOrder moProductionOrder;
    private erp.lib.form.SFormField moFieldDate;
    private erp.lib.form.SFormField moFieldQuantity;
    private erp.lib.form.SFormField moFieldQuantityOriginal;
    private erp.lib.form.SFormField moFieldQuantityRework;
    private erp.lib.form.SFormField moFieldDbmsUnitSymbolQO;
    private erp.lib.form.SFormField moFieldDbmsUnitSymbolQR;
    private erp.lib.form.SFormField moFieldDbmsUnitSymbol;

    private erp.mitm.data.SDataItem moItem;

    /** Creates new form DFormCompany */
    public SDialogMfgAssignRework(erp.client.SClientInterface client) {
        super(client.getFrame(), true);
        miClient = client;
        mnFormType = SDataConstants.MFG_ORD;

        initComponents();
        initComponentsExtra();
    }

    /** This method is called from within the constructor to
     * initialize the form.
     * WARNING: Do NOT modify this code. The content of this method is
     * always regenerated by the Form Editor.
     */
    // <editor-fold defaultstate="collapsed" desc="Generated Code">//GEN-BEGIN:initComponents
    private void initComponents() {

        bgCurrency = new javax.swing.ButtonGroup();
        buttonGroup1 = new javax.swing.ButtonGroup();
        jpData = new javax.swing.JPanel();
        jPanel8 = new javax.swing.JPanel();
        jPanel4 = new javax.swing.JPanel();
        jlCompanyBranch = new javax.swing.JLabel();
        jtfCompanyBranch = new javax.swing.JTextField();
        jPanel32 = new javax.swing.JPanel();
        jlEntity = new javax.swing.JLabel();
        jtfEntity = new javax.swing.JTextField();
        jPanel33 = new javax.swing.JPanel();
        jlType = new javax.swing.JLabel();
        jtfType = new javax.swing.JTextField();
        jPanel34 = new javax.swing.JPanel();
        jlFinishedGood = new javax.swing.JLabel();
        jtfFinishedGood = new javax.swing.JTextField();
        jPanel35 = new javax.swing.JPanel();
        jlFormula = new javax.swing.JLabel();
        jtfFormula = new javax.swing.JTextField();
        jPanel37 = new javax.swing.JPanel();
        jlDate = new javax.swing.JLabel();
        jtfDate = new javax.swing.JFormattedTextField();
        jPanel39 = new javax.swing.JPanel();
        jlNumber = new javax.swing.JLabel();
        jtfNumber = new javax.swing.JTextField();
        jPanel36 = new javax.swing.JPanel();
        jlQuantityOriginal = new javax.swing.JLabel();
        jtfQuantityOriginal = new javax.swing.JTextField();
        jtfDbmsUnitSymbolQO = new javax.swing.JTextField();
        jPanel38 = new javax.swing.JPanel();
        jlQuantityRework = new javax.swing.JLabel();
        jtfQuantityRework = new javax.swing.JTextField();
        jtfDbmsUnitSymbolQR = new javax.swing.JTextField();
        jPanel21 = new javax.swing.JPanel();
        jlQuantity = new javax.swing.JLabel();
        jtfQuantity = new javax.swing.JTextField();
        jtfDbmsUnitSymbol = new javax.swing.JTextField();
        jPanel2 = new javax.swing.JPanel();
        jbOk = new javax.swing.JButton();
        jbCancel = new javax.swing.JButton();

        setDefaultCloseOperation(javax.swing.WindowConstants.DISPOSE_ON_CLOSE);
        setTitle("Asignación de cantidad a reprocesar"); // NOI18N
        setModal(true);
        setResizable(false);
        addWindowListener(new java.awt.event.WindowAdapter() {
            public void windowActivated(java.awt.event.WindowEvent evt) {
                formWindowActivated(evt);
            }
        });

        jpData.setLayout(new java.awt.BorderLayout());

        jPanel8.setBorder(javax.swing.BorderFactory.createTitledBorder("Datos del registro:"));
        jPanel8.setLayout(new java.awt.GridLayout(10, 1, 0, 1));

        jPanel4.setLayout(new java.awt.FlowLayout(java.awt.FlowLayout.LEFT, 5, 0));

        jlCompanyBranch.setText("Sucursal:");
        jlCompanyBranch.setPreferredSize(new java.awt.Dimension(120, 23));
        jPanel4.add(jlCompanyBranch);

        jtfCompanyBranch.setEditable(false);
        jtfCompanyBranch.setText("COMPANY BRANCH");
        jtfCompanyBranch.setCaretPosition(1);
        jtfCompanyBranch.setFocusable(false);
        jtfCompanyBranch.setPreferredSize(new java.awt.Dimension(300, 23));
        jPanel4.add(jtfCompanyBranch);

        jPanel8.add(jPanel4);

        jPanel32.setLayout(new java.awt.FlowLayout(java.awt.FlowLayout.LEFT, 5, 0));

        jlEntity.setText("Planta:");
        jlEntity.setPreferredSize(new java.awt.Dimension(120, 23));
        jPanel32.add(jlEntity);

        jtfEntity.setEditable(false);
        jtfEntity.setText("ENTITY");
        jtfEntity.setCaretPosition(1);
        jtfEntity.setFocusable(false);
        jtfEntity.setPreferredSize(new java.awt.Dimension(300, 23));
        jPanel32.add(jtfEntity);

        jPanel8.add(jPanel32);

        jPanel33.setLayout(new java.awt.FlowLayout(java.awt.FlowLayout.LEFT, 5, 0));

        jlType.setText("Tipo ord. prod.:");
        jlType.setPreferredSize(new java.awt.Dimension(120, 23));
        jPanel33.add(jlType);

        jtfType.setEditable(false);
        jtfType.setText("TYPE");
        jtfType.setCaretPosition(1);
        jtfType.setFocusable(false);
        jtfType.setPreferredSize(new java.awt.Dimension(300, 23));
        jPanel33.add(jtfType);

        jPanel8.add(jPanel33);

        jPanel34.setLayout(new java.awt.FlowLayout(java.awt.FlowLayout.LEFT, 5, 0));

        jlFinishedGood.setText("Producto:");
        jlFinishedGood.setPreferredSize(new java.awt.Dimension(120, 23));
        jPanel34.add(jlFinishedGood);

        jtfFinishedGood.setEditable(false);
        jtfFinishedGood.setText("FINISHED GOOD");
        jtfFinishedGood.setCaretPosition(1);
        jtfFinishedGood.setFocusable(false);
        jtfFinishedGood.setPreferredSize(new java.awt.Dimension(300, 23));
        jPanel34.add(jtfFinishedGood);

        jPanel8.add(jPanel34);

        jPanel35.setLayout(new java.awt.FlowLayout(java.awt.FlowLayout.LEFT, 5, 0));

        jlFormula.setText("Fórmula:");
        jlFormula.setPreferredSize(new java.awt.Dimension(120, 23));
        jPanel35.add(jlFormula);

        jtfFormula.setEditable(false);
        jtfFormula.setText("FORMULA");
        jtfFormula.setCaretPosition(1);
        jtfFormula.setFocusable(false);
        jtfFormula.setPreferredSize(new java.awt.Dimension(300, 23));
        jPanel35.add(jtfFormula);

        jPanel8.add(jPanel35);

        jPanel37.setLayout(new java.awt.FlowLayout(java.awt.FlowLayout.LEFT, 5, 0));

        jlDate.setText("Fecha ord. prod.:");
        jlDate.setPreferredSize(new java.awt.Dimension(120, 23));
        jPanel37.add(jlDate);

        jtfDate.setEditable(false);
        jtfDate.setText("DATE");
        jtfDate.setPreferredSize(new java.awt.Dimension(120, 23));
        jPanel37.add(jtfDate);

        jPanel8.add(jPanel37);

        jPanel39.setLayout(new java.awt.FlowLayout(java.awt.FlowLayout.LEFT, 5, 0));

        jlNumber.setText("Folio:");
        jlNumber.setPreferredSize(new java.awt.Dimension(120, 23));
        jPanel39.add(jlNumber);

        jtfNumber.setEditable(false);
        jtfNumber.setFont(new java.awt.Font("Tahoma", 1, 11)); // NOI18N
        jtfNumber.setText("NUMBER");
        jtfNumber.setFocusable(false);
        jtfNumber.setPreferredSize(new java.awt.Dimension(120, 23));
        jPanel39.add(jtfNumber);

        jPanel8.add(jPanel39);

        jPanel36.setLayout(new java.awt.FlowLayout(java.awt.FlowLayout.LEFT, 5, 0));

        jlQuantityOriginal.setText("Cantidad original:");
        jlQuantityOriginal.setPreferredSize(new java.awt.Dimension(120, 23));
        jPanel36.add(jlQuantityOriginal);

        jtfQuantityOriginal.setEditable(false);
        jtfQuantityOriginal.setHorizontalAlignment(javax.swing.JTextField.RIGHT);
        jtfQuantityOriginal.setText("QUANTITY");
        jtfQuantityOriginal.setFocusable(false);
        jtfQuantityOriginal.setPreferredSize(new java.awt.Dimension(120, 23));
        jPanel36.add(jtfQuantityOriginal);

        jtfDbmsUnitSymbolQO.setEditable(false);
        jtfDbmsUnitSymbolQO.setText("UNIT");
        jtfDbmsUnitSymbolQO.setFocusable(false);
        jtfDbmsUnitSymbolQO.setPreferredSize(new java.awt.Dimension(30, 23));
        jPanel36.add(jtfDbmsUnitSymbolQO);

        jPanel8.add(jPanel36);

        jPanel38.setLayout(new java.awt.FlowLayout(java.awt.FlowLayout.LEFT, 5, 0));

        jlQuantityRework.setText("Cantidad reproceso: *");
        jlQuantityRework.setPreferredSize(new java.awt.Dimension(120, 23));
        jPanel38.add(jlQuantityRework);

        jtfQuantityRework.setHorizontalAlignment(javax.swing.JTextField.RIGHT);
        jtfQuantityRework.setText("0");
        jtfQuantityRework.setPreferredSize(new java.awt.Dimension(120, 23));
        jtfQuantityRework.addFocusListener(new java.awt.event.FocusAdapter() {
            public void focusLost(java.awt.event.FocusEvent evt) {
                jtfQuantityReworkFocusLost(evt);
            }
        });
        jPanel38.add(jtfQuantityRework);

        jtfDbmsUnitSymbolQR.setEditable(false);
        jtfDbmsUnitSymbolQR.setText("UNIT");
        jtfDbmsUnitSymbolQR.setFocusable(false);
        jtfDbmsUnitSymbolQR.setPreferredSize(new java.awt.Dimension(30, 23));
        jPanel38.add(jtfDbmsUnitSymbolQR);

        jPanel8.add(jPanel38);

        jPanel21.setLayout(new java.awt.FlowLayout(java.awt.FlowLayout.LEFT, 5, 0));

        jlQuantity.setText("Cantidad total:");
        jlQuantity.setPreferredSize(new java.awt.Dimension(120, 23));
        jPanel21.add(jlQuantity);

        jtfQuantity.setEditable(false);
        jtfQuantity.setHorizontalAlignment(javax.swing.JTextField.RIGHT);
        jtfQuantity.setText("0");
        jtfQuantity.setFocusable(false);
        jtfQuantity.setPreferredSize(new java.awt.Dimension(120, 23));
        jPanel21.add(jtfQuantity);

        jtfDbmsUnitSymbol.setEditable(false);
        jtfDbmsUnitSymbol.setText("UNIT");
        jtfDbmsUnitSymbol.setFocusable(false);
        jtfDbmsUnitSymbol.setPreferredSize(new java.awt.Dimension(30, 23));
        jPanel21.add(jtfDbmsUnitSymbol);

        jPanel8.add(jPanel21);

        jpData.add(jPanel8, java.awt.BorderLayout.CENTER);

        getContentPane().add(jpData, java.awt.BorderLayout.CENTER);

        jPanel2.setLayout(new java.awt.FlowLayout(java.awt.FlowLayout.RIGHT));

        jbOk.setText("Aceptar");
        jbOk.setToolTipText("[Ctrl + Enter]");
        jbOk.setPreferredSize(new java.awt.Dimension(75, 23));
        jPanel2.add(jbOk);

        jbCancel.setText("Cerrar"); // NOI18N
        jbCancel.setToolTipText("[Escape]");
        jbCancel.setPreferredSize(new java.awt.Dimension(75, 23));
        jPanel2.add(jbCancel);

        getContentPane().add(jPanel2, java.awt.BorderLayout.PAGE_END);

        java.awt.Dimension screenSize = java.awt.Toolkit.getDefaultToolkit().getScreenSize();
        setBounds((screenSize.width-458)/2, (screenSize.height-352)/2, 458, 352);
    }// </editor-fold>//GEN-END:initComponents

    private void formWindowActivated(java.awt.event.WindowEvent evt) {//GEN-FIRST:event_formWindowActivated
        windowActivated();
    }//GEN-LAST:event_formWindowActivated

    private void jtfQuantityReworkFocusLost(java.awt.event.FocusEvent evt) {//GEN-FIRST:event_jtfQuantityReworkFocusLost
        actionQuantityReworkFocusLost();
    }//GEN-LAST:event_jtfQuantityReworkFocusLost

    private void initComponentsExtra() {
        mvFields = new Vector<SFormField>();

        moFieldDate = new erp.lib.form.SFormField(miClient, SLibConstants.DATA_TYPE_DATE, false, jtfDate, jlDate);
        moFieldQuantityOriginal = new erp.lib.form.SFormField(miClient, SLibConstants.DATA_TYPE_DOUBLE, false, jtfQuantityOriginal, jlQuantityOriginal);
        moFieldDbmsUnitSymbolQO = new erp.lib.form.SFormField(miClient, SLibConstants.DATA_TYPE_STRING, false, jtfDbmsUnitSymbolQO, jlQuantityOriginal);
        moFieldQuantityRework = new erp.lib.form.SFormField(miClient, SLibConstants.DATA_TYPE_DOUBLE, true, jtfQuantityRework, jlQuantityRework);
        moFieldDbmsUnitSymbolQR = new erp.lib.form.SFormField(miClient, SLibConstants.DATA_TYPE_STRING, false, jtfDbmsUnitSymbolQR, jlQuantityRework);
        moFieldQuantity = new erp.lib.form.SFormField(miClient, SLibConstants.DATA_TYPE_DOUBLE, false, jtfQuantity, jlQuantity);
        moFieldDbmsUnitSymbol = new erp.lib.form.SFormField(miClient, SLibConstants.DATA_TYPE_STRING, false, jtfDbmsUnitSymbol, jlQuantity);

        mvFields.add(moFieldDate);
        mvFields.add(moFieldQuantityOriginal);
        mvFields.add(moFieldDbmsUnitSymbolQO);
        mvFields.add(moFieldQuantityRework);
        mvFields.add(moFieldDbmsUnitSymbolQR);
        mvFields.add(moFieldQuantity);
        mvFields.add(moFieldDbmsUnitSymbol);

        jbCancel.addActionListener(this);
        jbOk.addActionListener(this);

        AbstractAction actionOk = new AbstractAction() {
            @Override
            public void actionPerformed(ActionEvent e) { actionOk(); }
        };

        SFormUtilities.putActionMap(getRootPane(), actionOk, "ok", KeyEvent.VK_ENTER, KeyEvent.CTRL_DOWN_MASK);

        AbstractAction actionCancel = new AbstractAction() {
            @Override
            public void actionPerformed(ActionEvent e) { actionCancel(); }
        };

        SFormUtilities.putActionMap(getRootPane(), actionCancel, "cancel", KeyEvent.VK_ESCAPE, 0);
    }

    private void windowActivated() {
        if (mbFirstTime) {
            mbFirstTime = false;
            jtfQuantityRework.requestFocus();
        }
    }

    private void actionQuantityReworkFocusLost() {
        moFieldQuantity.setFieldValue(moFieldQuantityOriginal.getDouble() + moFieldQuantityRework.getDouble());
    }

    private void renderRecord() {
        jtfCompanyBranch.setText(moProductionOrder.getDbmsCompanyBranch());
        jtfEntity.setText(moProductionOrder.getDbmsEntity());
        jtfType.setText(moProductionOrder.getDbmsProductionOrderType());
        jtfFinishedGood.setText(moProductionOrder.getDbmsFinishedGood());
        jtfFinishedGood.setToolTipText(moProductionOrder.getDbmsFinishedGood());
        jtfFormula.setText(moProductionOrder.getDbmsBom());
        jtfFormula.setText(moProductionOrder.getDbmsBom());
        moFieldDate.setFieldValue(moProductionOrder.getDate());
        jtfNumber.setText(moProductionOrder.getDbmsNumber());
        moFieldQuantityOriginal.setFieldValue(moProductionOrder.getQuantityOriginal());
        jtfDbmsUnitSymbolQO.setText(moProductionOrder.getDbmsBomUnitSymbol());
        moFieldQuantityRework.setFieldValue(moProductionOrder.getQuantityRework());
        jtfDbmsUnitSymbolQR.setText(moProductionOrder.getDbmsBomUnitSymbol());
        moFieldQuantity.setFieldValue(moProductionOrder.getQuantity());
        jtfDbmsUnitSymbol.setText(moProductionOrder.getDbmsBomUnitSymbol());
    }

    private void actionEdit(boolean edit) {

    }

    private void actionOk() {
        SFormValidation validation = formValidate();

        if (validation.getIsError()) {
            if (validation.getComponent() != null) {
                validation.getComponent().requestFocus();
            }
            if (validation.getMessage().length() > 0) {
                miClient.showMsgBoxWarning(validation.getMessage());
            }
        }
        else {
            mnFormResult = SLibConstants.FORM_RESULT_OK;
            setVisible(false);
        }
        miClient.getGuiModule(SDataConstants.MOD_MFG).refreshCatalogues(SDataConstants.MFG_ORD);
    }

    private void actionCancel() {
        mnFormResult = SLibConstants.FORM_RESULT_CANCEL;
        miClient.getGuiModule(SDataConstants.MOD_MFG).refreshCatalogues(SDataConstants.MFG_ORD);
        setVisible(false);
    }

    // Variables declaration - do not modify//GEN-BEGIN:variables
    private javax.swing.ButtonGroup bgCurrency;
    private javax.swing.ButtonGroup buttonGroup1;
    private javax.swing.JPanel jPanel2;
    private javax.swing.JPanel jPanel21;
    private javax.swing.JPanel jPanel32;
    private javax.swing.JPanel jPanel33;
    private javax.swing.JPanel jPanel34;
    private javax.swing.JPanel jPanel35;
    private javax.swing.JPanel jPanel36;
    private javax.swing.JPanel jPanel37;
    private javax.swing.JPanel jPanel38;
    private javax.swing.JPanel jPanel39;
    private javax.swing.JPanel jPanel4;
    private javax.swing.JPanel jPanel8;
    private javax.swing.JButton jbCancel;
    private javax.swing.JButton jbOk;
    private javax.swing.JLabel jlCompanyBranch;
    private javax.swing.JLabel jlDate;
    private javax.swing.JLabel jlEntity;
    private javax.swing.JLabel jlFinishedGood;
    private javax.swing.JLabel jlFormula;
    private javax.swing.JLabel jlNumber;
    private javax.swing.JLabel jlQuantity;
    private javax.swing.JLabel jlQuantityOriginal;
    private javax.swing.JLabel jlQuantityRework;
    private javax.swing.JLabel jlType;
    private javax.swing.JPanel jpData;
    private javax.swing.JTextField jtfCompanyBranch;
    private javax.swing.JFormattedTextField jtfDate;
    private javax.swing.JTextField jtfDbmsUnitSymbol;
    private javax.swing.JTextField jtfDbmsUnitSymbolQO;
    private javax.swing.JTextField jtfDbmsUnitSymbolQR;
    private javax.swing.JTextField jtfEntity;
    private javax.swing.JTextField jtfFinishedGood;
    private javax.swing.JTextField jtfFormula;
    private javax.swing.JTextField jtfNumber;
    private javax.swing.JTextField jtfQuantity;
    private javax.swing.JTextField jtfQuantityOriginal;
    private javax.swing.JTextField jtfQuantityRework;
    private javax.swing.JTextField jtfType;
    // End of variables declaration//GEN-END:variables

    @Override
    public void formClearRegistry() {
        throw new UnsupportedOperationException("Not supported yet.");
    }

    @Override
    public void formReset() {
        mnFormResult = SLibConstants.UNDEFINED;
        mnFormStatus = SLibConstants.UNDEFINED;
        mbFirstTime = true;

        for (int i = 0; i < mvFields.size(); i++) {
            ((erp.lib.form.SFormField) mvFields.get(i)).resetField();
        }

        moFieldDate.setDate(miClient.getSessionXXX().getWorkingDate());
    }

    @Override
    public void formRefreshCatalogues() {

    }

    @Override
    public erp.lib.form.SFormValidation formValidate() {
        String message = "";

        SFormValidation validation = new SFormValidation();
        SDataStockLot oLot = null;

        for (int i = 0; i < mvFields.size(); i++) {
            if (!((erp.lib.form.SFormField) mvFields.get(i)).validateField()) {
                validation.setIsError(true);
                validation.setComponent(((erp.lib.form.SFormField) mvFields.get(i)).getComponent());
                break;
            }
        }

        return validation;
    }

    @Override
    public void setFormStatus(int status) {
        mnFormStatus = status;
    }

    @Override
    public void setFormVisible(boolean visible) {
        setVisible(visible);
    }

    @Override
    public int getFormStatus() {
        return mnFormStatus;
    }

    @Override
    public int getFormResult() {
        return mnFormResult;
    }

    @Override
    public void setRegistry(erp.lib.data.SDataRegistry registry) {
        throw new UnsupportedOperationException("Not supported yet.");
    }

    @Override
    public erp.lib.data.SDataRegistry getRegistry() {

        moProductionOrder.setQuantityRework(moFieldQuantityRework.getDouble());
        moProductionOrder.setQuantity(moFieldQuantity.getDouble());
        moProductionOrder.setFkUserEditId(miClient.getSession().getUser().getPkUserId());

        return moProductionOrder;
    }

    @Override
    public void setValue(int type, java.lang.Object value) {
        switch (type) {
            case 1:
                moProductionOrder = (SDataProductionOrder) SDataUtilities.readRegistry(miClient, SDataConstants.MFG_ORD, (int[]) value, SLibConstants.EXEC_MODE_VERBOSE);
                renderRecord();
                break;
        }
    }

    @Override
    public java.lang.Object getValue(int type) {
        throw new UnsupportedOperationException("Not supported yet.");
    }

    @Override
    public javax.swing.JLabel getTimeoutLabel() {
        return null;
    }

    @Override
    public void actionPerformed(java.awt.event.ActionEvent e) {
        if (e.getSource() instanceof javax.swing.JButton) {
            javax.swing.JButton button = (javax.swing.JButton) e.getSource();

            if (button == jbOk) {
                actionOk();
            }
            else if (button == jbCancel) {
                actionCancel();
            }
        }
    }

}
